version: 2
jobs:
  build-base:
    docker:
      - image: indigoag-docker.jfrog.io/indigo/node:6.11.0-indigo
        auth:
          username: $IA_ARTIFACTORY_USERNAME
          password: $IA_ARTIFACTORY_KEY
    working_directory: ~/packer
    steps:
      - checkout
      - run:
          name: Install packer
          command: ./ci/dependencies.sh
      - run:
          name: Validate base
          command: ./ci/packer-validate.sh
      - run:
          name: Set AWS Creds
          command: ../automation/tools/release-aws-credentials.sh
      - run:
          name: Build base
          command: ./ci/packer-build.sh
          no_output_timeout: 30m

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-base:
          context: org-global
